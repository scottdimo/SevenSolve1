<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, viewport-fit=cover"/>
  <title>Heptix</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <style>
    :root{
      /* Bright Azure palette */
      --bg:#EAF4FF; --ink:#0D1A2B; --muted:#52607A; --panel:#FFFFFF; --border:rgba(26,115,232,.18);
      --tile:#F4F9FF; --tile-alt:#EEF6FF; --accent:#1A73E8; --accent2:#4FC3F7; --good:#10B981;
      --bad:#EF4444; --warning:#F59E0B; --ring:rgba(26,115,232,.25);
      --glow:0 0 14px rgba(26,115,232,.22), 0 0 28px rgba(79,195,247,.18);
      --glow-soft:0 0 10px rgba(79,195,247,.22);
      --success-bg:#E8FFF6; --success-ink:#065F46; --notice-bg:#F1F6FF; --notice-ink:#0D1A2B;
    }
    [data-theme="dark"]{
      --bg:#0A0F1A; --ink:#EAF4FF; --muted:#A8B6CD; --panel:#0F1624; --border:rgba(148,163,184,.18);
      --tile:#0E1522; --tile-alt:#0B1220; --accent:#5EC0FF; --accent2:#8BC8FF; --good:#46FFB6;
      --bad:#FF6B6B; --warning:#FFD166; --ring:rgba(94,192,255,.35);
      --glow:0 0 14px rgba(94,192,255,.28), 0 0 26px rgba(139,200,255,.22);
      --glow-soft:0 0 12px rgba(94,192,255,.22);
      --success-bg:#10211B; --success-ink:#90FFE0; --notice-bg:#0F1426; --notice-ink:#DDE9FF;
    }

    *{box-sizing:border-box}
    body{
      margin:0; font-family:Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: radial-gradient(1000px 600px at 50% -8%, var(--tile-alt) 0%, var(--bg) 60%);
      color:var(--ink); min-height:100vh; display:grid; place-items:start center; padding:20px;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    .app{ width:100%; max-width:980px; background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:18px; box-shadow: var(--glow); position:relative; overflow:hidden; }
    header{ display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; margin-bottom:8px; }
    h1{ margin:0; font-size:24px; letter-spacing:.3px; display:flex; gap:10px; align-items:center; font-weight:800; text-shadow: var(--glow-soft); }
    .tag{font-size:12px; color:var(--muted); border:1px dashed var(--border); padding:2px 8px; border-radius:999px;}
    .controls{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .toggle,.group,.ghost{ display:inline-flex; gap:8px; align-items:center; background:var(--tile); border:1px solid var(--border); padding:8px 10px; border-radius:10px; font-size:13px; color:var(--muted); user-select:none; box-shadow: var(--glow-soft); }
    .ghost{ background:transparent; }
    .notice{ width:100%; background:var(--notice-bg); color:var(--notice-ink); border:1px solid var(--border); border-radius:12px; padding:10px 12px; font-size:13px; margin-bottom:10px; box-shadow: var(--glow-soft); }
    button{ background: linear-gradient(180deg, var(--accent2), var(--accent)); color:#fff; border:1px solid transparent;
      padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:800; letter-spacing:.2px; transition:.15s ease; box-shadow: var(--glow-soft); }
    button:hover{ box-shadow: 0 0 0 3px var(--ring) inset, var(--glow-soft); transform: translateY(-1px); }
    button.primary{ background: linear-gradient(180deg, var(--accent), #3A8BF0); color:#fff; }
    button.purple{ background: linear-gradient(180deg, var(--accent2), #7FD9FF); color:#0A233D; }
    .cta{ background: linear-gradient(180deg, #7FD9FF, #1A73E8); color:#08253E; }

    .grid{ display:grid; grid-template-columns: 1fr; gap:16px; margin-top:8px; }
    .panel{ background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:14px; box-shadow: var(--glow-soft); }
    .section-title{ margin:0 0 10px 0; font-size:14px; color:var(--muted); text-transform:uppercase; letter-spacing:.12em; }
    .row{ display:grid; grid-template-columns: 160px 1fr; gap:10px; align-items:center; margin-top:6px; }
    .row label{ color:var(--muted); font-size:14px; }
    input[type="text"]{
      width:100%; padding:12px 12px; background:var(--tile); color:var(--ink);
      border:1px solid var(--border); border-radius:10px; outline:none; font-size:18px;
      letter-spacing:2px; text-transform:uppercase; transition: box-shadow .2s ease, transform .08s ease; box-shadow: var(--glow-soft);
      -webkit-text-fill-color: var(--ink);
    }
    input[type="text"]:focus{ box-shadow: 0 0 0 3px var(--ring) inset, var(--glow-soft); border-color:var(--accent); transform: translateY(-1px); }
    .history{ display:grid; gap:8px; }
    .guess-item{ padding:10px 12px; background:var(--tile); border:1px solid var(--border); border-radius:10px; box-shadow: var(--glow-soft); }
    .guess-row{ display:flex; gap:10px; align-items:flex-end; }
    .ltrCol{ display:grid; grid-template-rows:auto 16px; gap:6px; align-items:end; justify-items:center; }
    .ltr{ width:40px; height:44px; display:grid; place-items:center; border-radius:8px; background:var(--panel); border:1px solid var(--border); font-weight:900; letter-spacing:1px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .marker{ height:16px; display:grid; place-items:center; }
    .circ{ width:18px; height:18px; border-radius:999px; border:2px solid var(--good); display:inline-grid; place-items:center; font-size:11px; font-weight:800; color:var(--good); }
    .x{ width:18px; height:18px; border-radius:3px; background:var(--bad); display:inline-block; position:relative; }
    .x::before,.x::after{ content:""; position:absolute; left:50%; top:50%; width:12px; height:2px; background:#ffffff90; transform-origin:center; }
    .x::before{ transform: translate(-50%,-50%) rotate(45deg); } .x::after{ transform: translate(-50%,-50%) rotate(-45deg); }
    .status{ margin-top:6px; color:var(--muted); min-height:20px; }
    .letters{ display:flex; gap:6px; flex-wrap:wrap; }
    .letters .tile{ position:relative; width:36px; height:44px; display:grid; place-items:center; border-radius:8px; background:var(--tile); border:1px solid var(--border); font-weight:800; letter-spacing:1px; transition: transform .08s ease, box-shadow .2s ease; box-shadow: var(--glow-soft); }
    .letters .tile.dim{ opacity:.5; }
    .letters .tile.bad{ border-color: rgba(239,68,68,.25); box-shadow: inset 0 0 0 2px rgba(239,68,68,.14), var(--glow-soft); }
    .letters .tile.slash::after{ content:""; position:absolute; top:50%; left:10%; right:10%; height:2px; background: currentColor; transform: rotate(-24deg); }
    .letters .tile.bump{ transform: scale(1.06); box-shadow: 0 0 14px rgba(26,115,232,.35); }
    .footer{ margin-top:12px; display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; color:var(--muted); font-size:13px; }
    .hidden{ display:none !important; } .success{ color:var(--good); } .warning{ color:var(--warning); } .rowtitle{ font-size:13px; color:var(--muted); margin-top:10px; }

    /* ROUND 6 underline slots */
    .slots{ display:grid; grid-template-columns: repeat(7, 1fr); gap:10px; margin-top:10px; }
    .slot{ position:relative; padding:6px 0 0; background:transparent; border:none; }
    .slot input{
      width:100%; background:transparent; color:var(--ink); border:none; outline:none; text-align:center;
      font-weight:900; text-transform:uppercase; letter-spacing:.04em;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      caret-color: var(--accent);
      -webkit-appearance:none; appearance:none;
      -webkit-text-fill-color: var(--ink);
      font-size: clamp(22px, 5.2vw, 34px);
      line-height: 1.15;
      padding: 2px 0 6px;
    }
    .slot .line{ position:relative; height:2px; background:var(--ink); opacity:.3; border-radius:2px; }
    .shake{ animation: shake .25s ease; }
    .overlay{ position:absolute; inset:0; display:grid; place-items:center; background: radial-gradient(900px 600px at 50% -10%, rgba(0,0,0,0.08), rgba(0,0,0,0.25)); pointer-events:none; opacity:0; transition: opacity .25s ease; }
    .overlay.show{ opacity:1; pointer-events:auto; }
    .toast{ background: var(--success-bg); color: var(--success-ink); border:1px solid var(--good); padding:20px 18px; border-radius:14px; box-shadow: 0 10px 40px rgba(0,0,0,0.12); min-width:320px; text-align:center; animation: pop .22s ease; }
    .toast h2{ margin:0 0 6px 0; font-size:22px; } .toast p{ margin:0; font-size:14px; color:inherit; opacity:.9; }
    .confetti{ position:absolute; width:8px; height:14px; border-radius:2px; top:-10px; opacity:.95; }
    @keyframes pop{ from{ transform: scale(.96); opacity:0;} to{ transform: scale(1); opacity:1;} }
    @keyframes fall{ to{ transform: translateY(110vh) rotate(360deg);} }
    @keyframes shake{ 0%{ transform: translateX(0);} 25%{ transform: translateX(-3px);} 50%{ transform: translateX(3px);} 75%{ transform: translateX(-2px);} 100%{ transform: translateX(0);} }

    /* Modal */
    .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background: rgba(0,0,0,.45); padding:20px; z-index:20; }
    .modal.show{ display:flex; }
    .modal-card{ width:min(820px, 95vw); background:var(--panel); color:var(--ink); border:1px solid var(--border); border-radius:14px; padding:18px; box-shadow: var(--glow); }
    .modal-card h3{ margin:0 0 10px 0; }
    .modal-body{ min-height:220px; line-height:1.6; color:var(--muted); }
    .modal-footer{ display:flex; gap:8px; justify-content:flex-end; margin-top:12px; }
    .how-visual{ display:flex; gap:16px; align-items:center; flex-wrap:wrap; margin-top:12px; }
    .how-visual .fake-shot{ width:100%; border:1px solid var(--border); border-radius:12px; background: var(--tile); padding:12px; box-shadow: var(--glow-soft); }
    .how-visual .fake-title{ font-weight:800; color:var(--ink); margin-bottom:8px; }
    .how-visual .fake-row{ display:flex; gap:8px; }
    .how-visual .fake-slot{ flex:1; height:44px; background:var(--panel); border:1px solid var(--border); border-radius:8px; display:grid; place-items:center; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .brand-splash{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background: radial-gradient(1200px 800px at 50% -12%, var(--tile-alt) 0%, var(--bg) 70%); z-index:50; }
    .brand-card{ background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:26px; width:min(760px,92vw); text-align:center; box-shadow: var(--glow); }
    .logo-hero{ font-weight:900; font-size:38px; letter-spacing:.02em; color:var(--ink); display:flex; gap:10px; align-items:flex-end; justify-content:center; }
    .logo-hero .seven{ font-size:52px; line-height:1; color:var(--accent); transform: translateY(2px); text-shadow: var(--glow-soft); }
    .tagline{ color:var(--muted); margin-top:8px; font-size:16px; }
    .brand-actions{ margin-top:18px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }
  </style>
</head>
<body>
  <!-- Splash (first view) -->
  <div id="brandSplash" class="brand-splash">
    <div class="brand-card">
      <div class="logo-hero"><span class="seven">7</span> HEPTIX</div>
      <div class="tagline">A word game for pattern thinkers.</div>
      <div class="brand-actions">
        <button id="splashHow" class="cta">How to play</button>
        <button id="splashNew" class="primary">New Game</button>
      </div>
    </div>
  </div>

  <div class="app">
    <header>
      <h1>Heptix <span class="tag">beta</span></h1>
      <div class="controls">
        <button id="howTo" class="cta">How to play</button>
        <button id="newGame" class="purple">New Game</button>
        <label class="group" title="Feedback style">
          Mode:
          <select id="modeSelect">
            <option value="standard" selected>Standard</option>
            <option value="insane">Insane</option>
          </select>
        </label>
        <label class="group" title="Rounds & hint limit">
          Difficulty:
          <select id="difficultySelect">
            <option value="normal" selected>Normal (5 probes, 3 hints)</option>
            <option value="hard">Hard (4 probes, 1 hint)</option>
          </select>
        </label>
        <label class="toggle" title="Dark theme">
          <input type="checkbox" id="themeToggle"/>
          Dark mode
        </label>
        <label class="toggle" title="Mute/unmute sounds (M)">
          <input type="checkbox" id="soundToggle" checked />
          Sound on
        </label>
      </div>
    </header>

    <div id="modeNotice" class="notice hidden">Insane mode is ON â€” repeated-letter counts are hidden during probe rounds.</div>

    <div class="grid">
      <section class="panel">
        <h3 class="section-title">Rounds 1â€“5: probe with 3-letter words</h3>
        <div class="row">
          <label for="guess3">3-letter guess</label>
          <div style="display:flex; gap:8px; width:100%;">
            <input id="guess3" type="text" maxlength="3" placeholder="e.g., CAT" autocomplete="off" autocapitalize="characters" spellcheck="false"/>
            <button class="primary" id="submit3" type="button">Submit</button>
          </div>
        </div>
        <div class="status" id="status3">You have <b id="roundsLeft">5</b> probe rounds.</div>
        <div class="history" id="history"></div>
      </section>

      <section class="panel">
        <h3 class="section-title">Round 6: 7-letter solve</h3>
        <div class="slots" id="slots"></div>
        <div style="display:flex; gap:8px; align-items:center; margin-top:6px; flex-wrap:wrap;">
          <button id="hintBtn" title="Reveal a correct letter in a random empty position" type="button">Hint</button>
          <button id="submitSolve" class="primary" title="Submit your 7-letter guess" type="button">Submit Guess</button>
          <button id="reveal" class="ghost" title="Show the answer" type="button">Reveal</button>
          <div class="hint-note">Hints used: <b id="hintsUsed">0</b> / <b id="hintsCap">3</b>. Type letters into the slotsâ€”focus auto-advances.</div>
        </div>
        <div class="status" id="status10">You can type in the slots at any time.</div>

        <div id="foundWrap" class="rowtitle">Letters found so far (<span id="foundCount">0</span>):</div>
        <div class="letters" id="foundLetters"></div>

        <div id="eliminatedWrap" class="rowtitle hidden">Eliminated letters:</div>
        <div class="letters" id="eliminatedLetters"></div>

        <div id="notGuessedWrap" class="rowtitle hidden">Not yet guessed:</div>
        <div class="letters" id="notGuessedLetters"></div>
      </section>

      <section class="panel">
        <h3 class="section-title">How scoring works</h3>
        <div class="footer">
          <div>Target words are 7 letters. Standard shows repeated letters; Insane hides counts.</div>
          <div><span id="debug" class="hidden"></span></div>
        </div>
      </section>
    </div>

    <div id="overlay" class="overlay" aria-live="polite">
      <div class="toast">
        <h2 id="overlayTitle">Nice! You solved it ðŸŽ‰</h2>
        <p id="overlayMsg">That was clean.</p>
        <div style="margin-top:10px; display:flex; gap:8px; justify-content:center;">
          <button id="playAgain" class="primary" type="button">Play again</button>
          <button id="closeOverlay" type="button">Close</button>
        </div>
      </div>
    </div>

    <div id="howtoModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="howtoTitle">
      <div class="modal-card">
        <h3 id="howtoTitle">How to play</h3>
        <div id="howtoBody" class="modal-body"></div>
        <div class="modal-footer">
          <button id="howtoPrev" class="ghost" type="button">Back</button>
          <button id="howtoNext" class="primary" type="button">Next</button>
          <button id="howtoClose" type="button">Close</button>
        </div>
      </div>
    </div>

  </div>

  <script>
    (function(){
      var TARGET_LEN = 7;

      // ===== Word library & randomization =====
      var BUILTIN_WORDS = [
        "ANALOGY","APRICOT","ARCHIVE","BALANCE","CAPTURE","CRYSTAL","DIAGRAM","EMERALD",
        "GLACIER","GRANITE","HARVEST","HORIZON","INSIGHT","JOURNEY","KINGDOM","LECTURE",
        "LIBRARY","MYSTERY","ORCHARD","OUTCOME","PAINTER","PRAIRIE","RAINBOW","RESOLVE",
        "REVOLVE","SCHOLAR","SECURED","SEQUOIA","SERPENT","SINCERE","SPARKLE","STADIUM",
        "SUNRISE","TERRACE","TEXTILE","THERMAL","UNRAVEL","VIBRANT","VILLAGE","ZEALOUS",
        "ACCOUNT","ACQUIRE","ADAPTED","ADJACENT","ADMIRER","ADVERSE","AFFINITY","AGILITY",
        "ALARMED","ALERTED","ALREADY","AMBIENT","ANCIENT","ANIMATE","APPEASE","ARRANGE",
        "ASCENDS","ASSERTS","ASTOUND","AUSPICE","AVARICE","BACKING","BARGAIN","BARRIER",
        "BEARING","BECOMES","BELONGS","BENEATH","BETRAYS","BRACING","BRIGHTE","BROCADE"
      ];
      var WORDS = [];
      var deck = [];
      var RECENT_KEY = "heptix_recent_targets_v1";

      function shuffleInPlace(a){
        var n=a.length;
        if (window.crypto && crypto.getRandomValues){
          var arr = new Uint32Array(n); crypto.getRandomValues(arr);
          for (var i=n-1;i>0;i--){ var j = arr[i] % (i+1); var t=a[i]; a[i]=a[j]; a[j]=t; }
        }else{
          for (var i=n-1;i>0;i--){ var j = Math.floor(Math.random()*(i+1)); var t=a[i]; a[i]=a[j]; a[j]=t; }
        }
        return a;
      }
      function normalizeWords(list){
        var out=[], seen={};
        for (var i=0;i<list.length;i++){
          var w=(list[i]||"").trim().toUpperCase();
          if (w.length===TARGET_LEN && /^[A-Z]+$/.test(w) && !seen[w]){ seen[w]=1; out.push(w); }
        }
        return out;
      }
      function loadRecent(){
        try{ return JSON.parse(localStorage.getItem(RECENT_KEY)||"[]"); }catch(_){ return []; }
      }
      function saveRecent(arr){ try{ localStorage.setItem(RECENT_KEY, JSON.stringify(arr.slice(-200))); }catch(_){ } }
      function buildDeck(){ deck = WORDS.slice(); shuffleInPlace(deck); }
      function drawNextWord(){
        var recent = loadRecent();
        if (!deck.length) buildDeck();
        for (var tries=0; tries<deck.length; tries++){
          var w = deck.pop();
          if (recent.indexOf(w) === -1) { recent.push(w); saveRecent(recent); return w; }
        }
        buildDeck(); var w2=deck.pop(); recent.push(w2); saveRecent(recent); return w2;
      }
      async function loadWords(){
        try{
          var resp = await fetch("words7.txt", {cache:"no-store"});
          if (!resp.ok) throw new Error("no words7.txt");
          var txt = await resp.text();
          var arr = txt.split(/\r?\n/).map(function(s){ return s.trim(); }).filter(Boolean);
          WORDS = normalizeWords(arr);
          if (WORDS.length < 50) throw new Error("too few words");
        }catch(e){
          WORDS = normalizeWords(BUILTIN_WORDS);
        }
        buildDeck();
      }

      // ===== Theme: LIGHT default, toggle dark =====
      var THEME_KEY = "heptix_theme";
      var themeToggle = document.getElementById("themeToggle");
      var savedTheme = localStorage.getItem(THEME_KEY) || "light";
      document.documentElement.setAttribute("data-theme", savedTheme);
      themeToggle.checked = (savedTheme === "dark");
      themeToggle.addEventListener("change", function(e){
        var t = e.target.checked ? "dark" : "light";
        document.documentElement.setAttribute("data-theme", t);
        localStorage.setItem(THEME_KEY, t);
      });

      // ===== Sounds =====
      var audioCtx = null, soundKey = "heptix_sound";
      var soundOn = localStorage.getItem(soundKey) !== "off";
      var soundToggle = document.getElementById("soundToggle");
      soundToggle.checked = soundOn;
      function getAudioCtx(){ if(!soundOn) return null; if(!audioCtx){ var Ctx = window.AudioContext||window.webkitAudioContext; if(!Ctx) return null; audioCtx = new Ctx(); } if(audioCtx&&audioCtx.state==="suspended") try{audioCtx.resume();}catch(_){ } return audioCtx; }
      function setSound(on){ soundOn = on; localStorage.setItem(soundKey, on?"on":"off"); soundToggle.checked = on; }
      document.addEventListener("keydown", function(e){ if((e.key||"").toLowerCase()==="m") setSound(!soundOn); });
      soundToggle.addEventListener("change", function(e){ setSound(!!e.target.checked); });
      function primeAudio(){ getAudioCtx(); document.removeEventListener("click", primeAudio); document.removeEventListener("touchstart", primeAudio); }
      document.addEventListener("click", primeAudio); document.addEventListener("touchstart", primeAudio);

      function chirp(startFreq,endFreq,dur,type,gain){
        if (!soundOn) return; var ctx = getAudioCtx(); if(!ctx) return; dur = dur||140; type=type||"sine"; gain=gain||0.03;
        var o = ctx.createOscillator(), g = ctx.createGain(); o.type = type;
        try{ o.frequency.setValueAtTime(startFreq, ctx.currentTime); o.frequency.exponentialRampToValueAtTime(endFreq, ctx.currentTime+dur/1000); }catch(_){ o.frequency.setValueAtTime(startFreq, ctx.currentTime); o.frequency.linearRampToValueAtTime(endFreq, ctx.currentTime+dur/1000); }
        g.gain.setValueAtTime(gain, ctx.currentTime); try{ g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+dur/1000); }catch(_){ g.gain.linearRampToValueAtTime(0.0001, ctx.currentTime+dur/1000); }
        o.connect(g).connect(ctx.destination); o.start(); o.stop(ctx.currentTime+dur/1000);
      }
      function whiteNoise(dur, gain, lpFreq){
        if (!soundOn) return; var ctx = getAudioCtx(); if(!ctx) return;
        var bufferSize = Math.floor(ctx.sampleRate * dur);
        var buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
        var data = buffer.getChannelData(0);
        for (var i=0;i<bufferSize;i++){ data[i] = Math.random()*2-1; }
        var src = ctx.createBufferSource(); src.buffer = buffer;
        var g = ctx.createGain(); g.gain.setValueAtTime(gain, ctx.currentTime);
        var f = ctx.createBiquadFilter(); f.type='lowpass'; f.frequency.value = lpFreq || 2000;
        src.connect(f).connect(g).connect(ctx.destination);
        src.start(); src.stop(ctx.currentTime + dur);
      }
      var sfx = {
        probeGood: function(){ chirp(520,800,120,"triangle",0.035); },
        probeBad: function(){ chirp(240,160,140,"sine",0.035); },
        place: function(){ chirp(520,540,60,"square",0.02); },
        hint: function(){ chirp(740,1000,160,"triangle",0.03); },
        winCheer: function(){ whiteNoise(1.6, 0.05, 2200);
          [660, 880, 990, 1180, 1320].forEach(function(f,i){ setTimeout(function(){ chirp(f, f+80, 150, "triangle", 0.035); }, 110*i); });
        }
      };

      // ===== Game state =====
      var state = { target:"", found:new Set(), eliminated:new Set(), guessed:new Set(), roundsUsed:0, maxProbeRounds:5, finished:false, mode:"standard", difficulty:"normal", usedInSlotsCounts:{}, slots:Array(TARGET_LEN).fill(""), hintsUsed:0, hintsCap:3 };

      // Helpers
      function letterCounts(word){ var m={}; for (var i=0;i<word.length;i++){ var ch=word[i]; m[ch]=(m[ch]||0)+1; } return m; }
      function isAlpha(str){ return /^[A-Za-z]+$/.test(str); }

      // DOM
      var historyEl = document.getElementById("history");
      var roundsLeftEl = document.getElementById("roundsLeft");
      var status3El = document.getElementById("status3");
      var status10El = document.getElementById("status10");
      var foundLettersEl = document.getElementById("foundLetters");
      var foundCountEl = document.getElementById("foundCount");
      var eliminatedLettersEl = document.getElementById("eliminatedLetters");
      var notGuessedLettersEl = document.getElementById("notGuessedLetters");
      var guess3El = document.getElementById("guess3");
      var foundWrap = document.getElementById("foundWrap");
      var eliminatedWrap = document.getElementById("eliminatedWrap");
      var notGuessedWrap = document.getElementById("notGuessedWrap");
      var slotsEl = document.getElementById("slots");
      var hintBtn = document.getElementById("hintBtn");
      var hintsUsedEl = document.getElementById("hintsUsed");
      var hintsCapEl = document.getElementById("hintsCap");
      var overlay = document.getElementById("overlay");
      var overlayTitle = document.getElementById("overlayTitle");
      var overlayMsg = document.getElementById("overlayMsg");
      var closeOverlay = document.getElementById("closeOverlay");
      var playAgain = document.getElementById("playAgain");
      var revealBtn = document.getElementById("reveal");
      var submitSolveBtn = document.getElementById("submitSolve");
      var howButton = document.getElementById("howTo");
      var howModal=document.getElementById("howtoModal"), howBody=document.getElementById("howtoBody");
      var howPrev=document.getElementById("howtoPrev"), howNext=document.getElementById("howtoNext"), howClose=document.getElementById("howtoClose");
      var howPage=0;

      function applyDifficulty(d){
        state.difficulty = d;
        var cfg = { normal:{probes:5,hintCap:3}, hard:{probes:4,hintCap:1} }[d];
        state.maxProbeRounds = cfg.probes; state.hintsCap = cfg.hintCap;
        hintsCapEl.textContent = state.hintsCap;
        roundsLeftEl.textContent = state.maxProbeRounds - state.roundsUsed;
        status3El.innerHTML = "You have <b id='roundsLeft'>" + (state.maxProbeRounds - state.roundsUsed) + "</b> probe rounds.";
      }

      function startNewGame(){
        state.target = drawNextWord();
        state.roundsUsed = 0; state.finished=false;
        state.found.clear(); state.eliminated.clear(); state.guessed.clear();
        state.usedInSlotsCounts = {}; state.slots = Array(TARGET_LEN).fill("");
        state.hintsUsed = 0; hintsUsedEl.textContent = "0"; hintsCapEl.textContent = state.hintsCap;
        historyEl.innerHTML=""; roundsLeftEl.textContent = state.maxProbeRounds - state.roundsUsed;
        status3El.innerHTML = "You have <b id='roundsLeft'>" + (state.maxProbeRounds - state.roundsUsed) + "</b> probe rounds.";
        status10El.textContent = "You can type in the slots at any time.";
        renderFound(); renderEliminated(); renderNotGuessed();
        renderSlots(true); hintBtn.disabled=false;
      }

      function bumpTiles(container){ var tiles = container.querySelectorAll('.tile'); for (var i=0;i<tiles.length;i++){ (function(t){ t.classList.add('bump'); setTimeout(function(){ t.classList.remove('bump'); },110); })(tiles[i]); } }

      function renderFound(){
        var counts = letterCounts(state.target);
        var arr = Array.from(state.found).sort(); var tiles = [];
        if (state.mode === "standard"){ for (var i=0;i<arr.length;i++){ var ch=arr[i]; var n=counts[ch]||1; for (var j=0;j<n;j++) tiles.push(ch); } }
        else { tiles = arr; }
        var useCounts = Object.assign({}, state.usedInSlotsCounts); var html="";
        for (var k=0;k<tiles.length;k++){ var c=tiles[k]; var classes=["tile"]; if((useCounts[c]||0)>0){ classes.push("slash"); useCounts[c]--; } html += "<div class='"+classes.join(" ")+"'>"+c+"</div>"; }
        foundLettersEl.innerHTML = html; foundWrap.classList.toggle("hidden", tiles.length===0); bumpTiles(foundLettersEl);
        foundCountEl.textContent = tiles.length;
      }

      function renderEliminated(){
        var arr = Array.from(state.eliminated).sort(); var html="";
        for (var i=0;i<arr.length;i++){ var ch=arr[i]; var classes=["tile","bad"]; if((state.usedInSlotsCounts[ch]||0)>0) classes.push("slash"); html += "<div class='"+classes.join(" ")+"'>"+ch+"</div>"; }
        eliminatedLettersEl.innerHTML = html; eliminatedWrap.classList.toggle("hidden", arr.length===0); bumpTiles(eliminatedLettersEl);
      }

      function renderNotGuessed(){
        var ALFA = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
        var remaining = ALFA.filter(function(ch){ return !state.guessed.has(ch); });
        var html=""; for (var i=0;i<remaining.length;i++){ var ch=remaining[i]; var classes=["tile","dim"]; if((state.usedInSlotsCounts[ch]||0)>0) classes.push("slash"); html += "<div class='"+classes.join(" ")+"'>"+ch+"</div>"; }
        notGuessedLettersEl.innerHTML = html; notGuessedWrap.classList.toggle("hidden", remaining.length===26);
      }

      // New: clearer per-letter feedback row
      function addHistoryRow(guess, markers){
        var row = document.createElement("div"); row.className = "guess-item";
        var inner = document.createElement("div"); inner.className = "guess-row";
        for (var i=0;i<guess.length;i++){
          var col = document.createElement("div"); col.className="ltrCol";
          var tile = document.createElement("div"); tile.className="ltr"; tile.textContent = guess[i];
          var mk = document.createElement("div"); mk.className="marker";
          var m = markers[i];
          if (m.in){
            var circ = document.createElement("div"); circ.className="circ"; circ.textContent = m.count;
            mk.appendChild(circ);
          }else{
            var x = document.createElement("div"); x.className="x"; mk.appendChild(x);
          }
          col.appendChild(tile); col.appendChild(mk); inner.appendChild(col);
        }
        row.appendChild(inner); historyEl.prepend(row);
      }

      function validateProbeWord(g){ return g.length===3 && isAlpha(g); }

      function handleProbe(){
        if (state.finished) return;
        var g=(guess3El.value||"").trim().toUpperCase();
        if (!validateProbeWord(g)){ status3El.innerHTML = "<span class='warning'>Enter a valid 3-letter word (Aâ€“Z only).</span>"; sfx.probeBad(); guess3El.focus(); return; }
        var counts = letterCounts(state.target); var markers=[];
        for (var i=0;i<3;i++){ var ch=g[i]; state.guessed.add(ch);
          if (state.target.indexOf(ch)!==-1){ markers.push({in:true,count:counts[ch]||1}); state.found.add(ch); state.eliminated.delete(ch); sfx.probeGood(); }
          else { markers.push({in:false}); state.eliminated.add(ch); sfx.probeBad(); } }
        addHistoryRow(g,markers); renderFound(); renderEliminated(); renderNotGuessed();
        state.roundsUsed += 1; var left=state.maxProbeRounds - state.roundsUsed;
        roundsLeftEl.textContent = left; status3El.innerHTML = left>0? "You have <b>"+left+"</b> probe rounds left." : "Probe phase complete.";
        guess3El.value=""; guess3El.focus();
      }

      function renderSlots(focusFirst){
        slotsEl.innerHTML="";
        for (var i=0;i<TARGET_LEN;i++){ (function(idx){
          var slot=document.createElement("div"); slot.className="slot";
          var input=document.createElement("input");
          input.setAttribute("maxlength","1"); input.setAttribute("inputmode","text");
          input.setAttribute("autocomplete","off"); input.setAttribute("autocapitalize","characters");
          input.setAttribute("spellcheck","false"); input.value = state.slots[idx];
          slot.addEventListener("click", function(){ input.focus(); });
          input.addEventListener("input", function(e){
            var v=(e.target.value||"").toUpperCase().replace(/[^A-Z]/g,"");
            e.target.value=v; state.slots[idx]=v; sfx.place();
            recomputeUsedInSlotsCounts(); checkSolved();
            if (v && idx<TARGET_LEN-1){ var next=slotsEl.children[idx+1].querySelector("input"); if(next) next.focus(); }
          });
          input.addEventListener("keydown", function(e){
            if (e.key==="Backspace" && !e.target.value && idx>0){ var prev=slotsEl.children[idx-1].querySelector("input"); if(prev) prev.focus(); }
            if (e.key==="ArrowLeft" && idx>0){ var prev2=slotsEl.children[idx-1].querySelector("input"); if(prev2) prev2.focus(); }
            if (e.key==="ArrowRight" && idx<TARGET_LEN-1){ var next2=slotsEl.children[idx+1].querySelector("input"); if(next2) next2.focus(); }
          });
          slot.appendChild(input); var line=document.createElement("div"); line.className="line"; slot.appendChild(line); slotsEl.appendChild(slot);
        })(i); }
        if (focusFirst){ var first=slotsEl.querySelector("input"); if(first) first.focus(); }
      }

      function clearSlots(){
        for (var i=0;i<TARGET_LEN;i++){
          state.slots[i] = "";
          var input = slotsEl.children[i].querySelector("input"); if (input){ input.value=""; }
        }
        recomputeUsedInSlotsCounts();
      }

      function recomputeUsedInSlotsCounts(){
        state.usedInSlotsCounts={}; for (var i=0;i<state.slots.length;i++){ var ch=state.slots[i]; if(ch) state.usedInSlotsCounts[ch]=(state.usedInSlotsCounts[ch]||0)+1; }
        renderFound(); renderEliminated(); renderNotGuessed();
      }

      function updateHintState(){ hintsUsedEl.textContent=String(state.hintsUsed); hintsCapEl.textContent=String(state.hintsCap); }

      function hint(){
        var emptyIdx=[]; for (var i=0;i<TARGET_LEN;i++){ if(!state.slots[i]) emptyIdx.push(i); }
        if (emptyIdx.length===0){ status10El.textContent="All slots are filled."; slotsEl.classList.add('shake'); setTimeout(function(){ slotsEl.classList.remove('shake'); },260); return; }
        if (state.hintsUsed>=state.hintsCap){ status10El.textContent="No hints remaining."; slotsEl.classList.add('shake'); setTimeout(function(){ slotsEl.classList.remove('shake'); },260); return; }
        var idx=emptyIdx[Math.floor(Math.random()*emptyIdx.length)]; var letter=state.target[idx];
        var input=slotsEl.children[idx].querySelector("input");
        if (input){
          input.focus();
          input.value = letter;
          var ev = new Event('input', {bubbles:true});
          input.dispatchEvent(ev);
          sfx.hint();
          state.hintsUsed+=1; updateHintState();
          setTimeout(function(){
            for (var k=idx+1;k<state.slots.length;k++){
              var nxt = slotsEl.children[k].querySelector("input");
              if (nxt && !nxt.value){ nxt.focus(); break; }
            }
          }, 0);
        }
      }

      function reveal(){
        for (var i=0;i<TARGET_LEN;i++){ state.slots[i]=state.target[i]; var input=slotsEl.children[i].querySelector("input"); if(input){ input.value=state.target[i]; } }
        state.guessed = new Set(state.target.split("")); state.found = new Set(state.target.split(""));
        recomputeUsedInSlotsCounts();
        overlayTitle.textContent = "Better luck next time";
        overlayMsg.innerHTML = "The target was <b>"+state.target+"</b>.";
        overlay.classList.add('show');
      }

      function currentGuess(){ return state.slots.join(""); }
      function shakeSlots(){ slotsEl.classList.add('shake'); setTimeout(function(){ slotsEl.classList.remove('shake'); },260); }
      function celebrate(){ overlayTitle.textContent="Nice! You solved it ðŸŽ‰"; overlayMsg.textContent="That was clean."; overlay.classList.add('show'); sfx.winCheer(); launchConfetti(document.querySelector('.app')); }
      function launchConfetti(root){
        var colors=["#1A73E8","#4FC3F7","#10B981","#6C63FF","#F59E0B"];
        for (var i=0;i<90;i++){ var c=document.createElement('div'); c.className='confetti';
          c.style.left=(Math.random()*100)+'%'; c.style.background=colors[Math.floor(Math.random()*colors.length)];
          c.style.transform='translateY(-10px) rotate('+(Math.random()*360)+'deg)';
          c.style.animation='fall '+(2+Math.random()*2)+'s linear '+(Math.random()*0.8)+'s forwards';
          root.appendChild(c); (function(el){ setTimeout(function(){ el.remove(); },4000); })(c); }
      }

      function checkSolved(){ if (currentGuess().length===TARGET_LEN && currentGuess()===state.target){ celebrate(); } }

      function submitSolve(){
        var guess=currentGuess();
        if (guess.length<TARGET_LEN){ status10El.textContent="Finish all 7 letters, then Submit."; shakeSlots(); return; }
        if (guess===state.target){ celebrate(); return; }
        var prevGuessed = new Set(state.guessed);
        var u={}; for (var i=0;i<guess.length;i++) u[guess[i]]=true;
        Object.keys(u).forEach(function(ch){
          if (!prevGuessed.has(ch)){
            state.guessed.add(ch);
            if (state.target.indexOf(ch)===-1){ state.eliminated.add(ch); } else { state.found.add(ch); }
          }
        });
        renderFound(); renderEliminated(); renderNotGuessed();
        status10El.innerHTML = "<span class='warning'>Incorrect guess. New letters not in the word were eliminated.</span>";
        clearSlots();
        shakeSlots();
      }

      // How-to pages
      function renderHow(){
        if (howPage===0){
          // Page 1: Probe basics + tip about not repeating letters
          howBody.innerHTML = `
            <b>Probe Rounds (1â€“5):</b><br/>
            Enter 3-letter words to scout the target. Each letter shows if it exists in the word.
            <div class="how-visual">
              <div class="fake-shot">
                <div class="fake-title">Example probe</div>
                <div class="fake-row">
                  <div class="fake-slot">C</div>
                  <div class="fake-slot">A</div>
                  <div class="fake-slot">T</div>
                </div>
                <div style="margin-top:8px;display:flex;gap:12px;align-items:center;">
                  <span class="circ">1</span> <span class="muted">= letter is in target (count shown in Standard)</span>
                  <span class="x"></span> <span class="muted">= letter not in target</span>
                </div>
              </div>
            </div>
            <div style="margin-top:10px; color:var(--muted);"><b>Tip:</b> It's best <b>not to repeat the same letter</b> during probe rounds â€” youâ€™ll get more coverage.</div>
          `;
          howNext.style.display = "";
        } else if (howPage===1){
          // Page 2: Solve
          howBody.innerHTML = `
            <b>Round 6 (Solve):</b><br/>
            Type into the 7 lines. Focus auto-advances. Use <b>Hint</b> to place a correct letter. Submit checks the word and clears slots if wrong. Reveal shows the answer without a win.
            <div class="how-visual">
              <div class="fake-shot">
                <div class="fake-title">Solve layout</div>
                <div class="fake-row" style="gap:10px;">
                  ${Array.from({length:7}).map(()=>'<div class="fake-slot" style="height:30px;">&nbsp;</div>').join('')}
                </div>
              </div>
            </div>
          `;
          howNext.style.display = "";
        } else {
          // Page 3: Modes & difficulty
          howBody.innerHTML = `
            <b>Modes & Difficulty:</b><br/>
            <ul>
              <li><b>Standard mode</b>: shows repeated-letter counts during probes.</li>
              <li><b>Insane mode</b>: hides repeated-letter counts during probes.</li>
              <li><b>Normal difficulty</b>: 5 probe rounds, <b>3 hints</b>.</li>
              <li><b>Hard difficulty</b>: 4 probe rounds, <b>1 hint</b>.</li>
            </ul>
            <div class="how-visual">
              <div class="fake-shot">
                <div class="fake-title">Mode & difficulty controls</div>
                <div class="fake-row">
                  <div class="fake-slot" style="width:160px">Mode: Standard â–¾</div>
                  <div class="fake-slot" style="width:200px">Difficulty: Normal â–¾</div>
                </div>
              </div>
            </div>
          `;
          howNext.style.display = "none";
        }
      }
      document.getElementById("howTo").addEventListener("click", function(){ howPage=0; renderHow(); document.getElementById("howtoModal").classList.add("show"); });
      document.getElementById("howtoClose").addEventListener("click", function(){ document.getElementById("howtoModal").classList.remove("show"); });
      document.getElementById("howtoPrev").addEventListener("click", function(){ howPage=Math.max(0,howPage-1); renderHow(); });
      document.getElementById("howtoNext").addEventListener("click", function(){ howPage=Math.min(2,howPage+1); renderHow(); });

      // Events
      document.getElementById("newGame").addEventListener("click", function(){ startNewGame(); });
      document.getElementById("submit3").addEventListener("click", function(e){ e.preventDefault(); handleProbe(); });
      document.getElementById("guess3").addEventListener("keydown", function(e){ if (e.key==="Enter") handleProbe(); });
      document.getElementById("reveal").addEventListener("click", reveal);
      document.getElementById("submitSolve").addEventListener("click", submitSolve);
      document.getElementById("closeOverlay").addEventListener("click", function(){ overlay.classList.remove('show'); });
      document.getElementById("playAgain").addEventListener("click", function(){ overlay.classList.remove('show'); startNewGame(); });
      document.getElementById("hintBtn").addEventListener("click", hint);

      // Splash actions
      var splash = document.getElementById("brandSplash");
      document.getElementById("splashNew").addEventListener("click", function(){ sessionStorage.setItem("heptix_splash_seen","1"); splash.style.display="none"; startNewGame(); });
      document.getElementById("splashHow").addEventListener("click", function(){ sessionStorage.setItem("heptix_splash_seen","1"); splash.style.display="none"; howPage=0; renderHow(); document.getElementById("howtoModal").classList.add("show"); });

      // Mode selector & notice
      var modeSelect = document.getElementById("modeSelect");
      var modeNotice = document.getElementById("modeNotice");
      modeSelect.addEventListener("change", function(){
        state.mode = modeSelect.value;
        modeNotice.classList.toggle("hidden", state.mode!=="insane");
      });

      // Difficulty selector
      var difficultySelect = document.getElementById("difficultySelect");
      difficultySelect.addEventListener("change", function(){
        applyDifficulty(difficultySelect.value);
      });

      // Init
      loadWords().then(function(){ applyDifficulty("normal"); if (sessionStorage.getItem("heptix_splash_seen")==="1"){ document.getElementById("brandSplash").style.display="none"; startNewGame(); } });
    })();
  </script>
</body>
</html>
